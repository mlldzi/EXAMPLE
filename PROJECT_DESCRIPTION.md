# Подробное описание проекта: Единый глоссарий терминов ВНД

## 1. Обзор Проекта

Проект "Единый глоссарий терминов ВНД" - это комплексное веб-приложение, разработанное для централизации и систематизации терминологии, содержащейся в нормативных документах высшего учебного заведения (ВНД). Основная цель системы - обеспечить единый источник достоверных определений, упростить поиск и использование терминов, а также автоматизировать процесс выявления и анализа разночтений в определениях из различных нормативных актов. Система предоставляет функционал для пользователей с разными ролями (от обычных пользователей до администраторов) для взаимодействия с глоссарием и документами.

## 2. Технологический Стек

Проект построен на современном и асинхронном технологическом стеке:

-   **Бэкенд:** Разработан с использованием высокопроизводительного асинхронного фреймворка **FastAPI** на Python. Для взаимодействия с базой данных используется **Motor**, асинхронный драйвер для MongoDB.
-   **База данных:** **MongoDB** выбрана как NoSQL база данных, обеспечивающая гибкость схемы данных, необходимую для хранения терминов с различной структурой определений, истории изменений и метаданных документов.
-   **Фронтенд:** Реализован как SPA (Single Page Application) с использованием библиотеки **React** и инструмента сборки **Vite**. Это обеспечивает быструю загрузку, динамичный интерфейс и удобную компонентную разработку.
-   **Контейнеризация:** Проект упакован в **Docker** контейнеры, а управление мультиконтейнерным приложением осуществляется через **Docker Compose**. Это обеспечивает переносимость, упрощает настройку окружения для разработки и потенциальное развертывание.
-   **Аутентификация:** Для безопасного доступа к API используется механизм аутентификации на основе **JWT (JSON Web Tokens)**, с поддержкой refresh-токенов для обновления сессии.
-   **Тестирование:** Покрытие бэкенда тестами реализовано с использованием фреймворка **pytest**, с акцентом на интеграционные тесты API и CRUD операций, а также юнит-тесты для специфической логики (например, обнаружения конфликтов).

## 3. Архитектура Приложения

Архитектура проекта следует принципам клиент-серверного взаимодействия с четким разделением ролей:

-   **Серверная Часть (Бэкенд):** Представляет собой API-сервис на FastAPI. Код бэкенда организован в директории `backend/app/`:
    -   `main.py`: Точка входа приложения, настройка FastAPI, CORS и подключение маршрутов.
    -   `core/`: Содержит базовую конфигурацию (`config.py`), утилиты безопасности (`security.py`).
    -   `db/`: Содержит логику подключения и управления сессией MongoDB (`session.py`).
    -   `models/`: Определяет структуры данных (Pydantic модели) для всех сущностей системы (пользователи, термины, документы, связи, токены, профили) и базовые классы (`base.py`, `time_stamped_model.py`).
    -   `crud/`: Реализует логику взаимодействия с базой данных (Create, Read, Update, Delete) для каждой модели (`user.py`, `term.py`, `document.py`, `term_document.py`).
    -   `api/v1/endpoints/`: Содержит обработчики API запросов (эндпоинты) для каждой предметной области (`auth.py`, `users.py`, `terms.py`, `documents.py`, `term_document_relations.py`).
-   **Клиентская Часть (Фронтенд):** React приложение, расположенное в директории `frontend/src/`:
    -   `main.jsx`: Точка входа React приложения.
    -   `App.jsx`: Настройка маршрутизации (`react-router-dom`) и общего макета приложения.
    -   `contexts/`: Содержит React Context для управления состоянием аутентификации (`AuthContext.jsx`), включая логику хранения токенов и их автоматического обновления через перехватчики Axios.
    -   `api/`: Содержит клиентские модули для взаимодействия с бэкенд API (`apiClient.js` - базовый клиент Axios, `terms.js`, `documents.js`, `termDocumentRelations.js` - функции для конкретных ресурсов).
    -   `pages/`: Реализует основные страницы приложения (`LoginPage.jsx`, `RegisterPage.jsx`, `DashboardPage.jsx`, `SearchPage.jsx`, `TermPage.jsx`, `DocumentPage.jsx`, `DocumentAnalysisPage.jsx`).
    -   `components/`: Содержит переиспользуемые компоненты UI, разделенные по категориям (например, `display/`, `forms/`, `common/`).
-   **База Данных:** Работает в отдельном контейнере Docker.

Взаимодействие между фронтендом и бэкендом происходит посредством RESTful API запросов.

## 4. Ключевой Функционал (Подробно)

### 4.1. Бэкенд

-   **Управление Пользователями (`users.py`, `auth.py`, `crud/user.py`, `models/user.py`, `models/token.py`):**
    -   **Регистрация:** Создание новых пользователей с проверкой уникальности email и сложностью пароля. Роль по умолчанию - `USER`. (`POST /api/v1/auth/register`)
    -   **Аутентификация:** Вход пользователя по email и паролю, выдача Access и Refresh токенов. (`POST /api/v1/auth/login`)
    -   **Обновление Токенов:** Получение нового Access токена по Refresh токену. (`POST /api/v1/auth/refresh`)
    -   **Отзыв Токена:** Позволяет сделать Refresh токен недействительным (заглушка эндпоинта в `AuthContext`, реальная реализация может потребоваться). (`POST /api/v1/auth/revoke_token` - предполагается)
    -   **Получение Текущего Пользователя:** Защищенный эндпоинт для получения данных пользователя, соответствующего Access токену в заголовках запроса. (`GET /api/v1/users/me`)
    -   **CRUD Пользователей:** (В `crud/user.py` и `api/v1/endpoints/users.py`) Базовые операции получения пользователя по ID, списка пользователей, обновления (с возможностью смены пароля, статуса, ролей) и удаления.
-   **Управление Терминами (`terms.py`, `crud/term.py`, `models/term.py`):**
    -   **CRUD Терминов:** Создание (`POST /api/v1/terms/`), получение по ID (`GET /api/v1/terms/{term_id}`), получение списка с фильтрацией/поиском (`GET /api/v1/terms/`), обновление (`PUT /api/v1/terms/{term_id}`), удаление (`DELETE /api/v1/terms/{term_id}`).
    -   **История Определений:** При обновлении определения термина, старое определение сохраняется в массиве `definitions_history` с информацией о пользователе, дате и источнике (документе).
    -   **Поиск Терминов:** Эндпоинт `GET /api/v1/terms/` с параметром `query` позволяет искать термины по названию, текущему определению и тегам (регистронезависимый поиск с использованием `$regex`).
    -   **Поиск по Определению:** Добавлен специфичный метод `search_by_definition` в `crud/term.py` для поиска исключительно по полю `current_definition` (используется в логике проверки конфликтов).
    -   **Связанные Документы:** Эндпоинт для получения списка документов, в которых используется данный термин. (`GET /api/v1/terms/{term_id}/documents`)
-   **Управление Документами (`documents.py`, `crud/document.py`, `models/document.py`):**
    -   **CRUD Документов:** Создание (`POST /api/v1/documents/`), получение по ID (`GET /api/v1/documents/{doc_id}`), получение списка с фильтрацией/поиском (`GET /api/v1/documents/`), обновление (`PUT /api/v1/documents/{doc_id}`), удаление (`DELETE /api/v1/documents/{doc_id}`). При удалении документа автоматически удаляются все связанные с ним `TermDocumentRelation` записи.
    -   **Поиск Документов:** Эндпоинт `GET /api/v1/documents/` с параметром `query` позволяет искать документы по названию, номеру, описанию, отделу и тегам (регистронезависимый поиск с использованием `$regex`).
    -   **Связанные Термины:** Эндпоинт для получения списка терминов, содержащихся в данном документе. (`GET /api/v1/documents/{doc_id}/terms`)
    -   **Статусы Документа:** Используется перечисление `DocumentStatus` (`DRAFT`, `ACTIVE`, `OUTDATED`, `ARCHIVED`). При смене статуса на `ACTIVE`, фиксируется пользователь и дата утверждения.
-   **Управление Связями Термин-Документ (`term_document_relations.py`, `crud/term_document.py`, `models/term_document.py`):**
    -   **CRUD Связей:** Создание (`POST /api/v1/term_document_relations/`), получение по ID (`GET /api/v1/term_document_relations/{relation_id}`), получение списка (`GET /api/v1/term_document_relations/`), обновление (`PUT /api/v1/term_document_relations/{relation_id}`), удаление (`DELETE /api/v1/term_document_relations/{relation_id}`). Также реализовано удаление по паре ID термина и документа, по ID термина (удаление всех связей для термина), по ID документа (удаление всех связей для документа).
    -   **Хранение Определения из Документа:** В модели `TermDocumentRelation` хранится `term_definition_in_document` - определение термина именно в контексте данного ВНД, а также `context` и `locations`.
-   **Анализ и Конфликты (`terms.py`, `term_document_relations.py`, `crud/term_document.py`, `models/term.py`, `models/term_document.py`):**
    -   **Проверка Конфликта Одиночного Термина:** Эндпоинт (`POST /api/v1/terms/check-conflict`) принимает данные потенциального термина (название, определение, год) и выполняет поиск существующих терминов по названию (точное совпадение без учета регистра) и определению (нечеткий поиск по подстроке). В ответе предоставляется информация о найденных конфликтующих терминах, включая их ID, название, определение и ID/название документа-источника текущего определения конфликтующего термина.
    -   **Отчет о Конфликтах для Термина:** Эндпоинт (`GET /api/v1/term_document_relations/conflicts/{term_id}`) собирает все определения данного термина из разных связанных документов и формирует отчет о парах различных определений и списках документов, содержащих каждое из этих определений.
    -   **Полный Отчет о Конфликтах:** Эндпоинт (`GET /api/v1/term_document_relations/conflicts`) находит все термины, у которых есть хотя бы два разных определения в разных связанных документах, и для каждого такого термина формирует отчет о конфликтах.
    -   **Статистика Использования Терминов:** Эндпоинт (`GET /api/v1/terms/statistics`) возвращает список всех терминов с указанием количества документов, в которых каждый термин используется (на основе связей `TermDocumentRelation`).
    -   **Массовое Сохранение Терминов:** Эндпоинт (`POST /api/v1/terms/bulk-save`) принимает список данных терминов (после анализа документа) и пытается сохранить их в базу данных. Это включает создание новых терминов или обновление существующих, если они найдены по названию. Может возвращать информацию об успешно сохраненных терминах и ошибках (например, дубликатах).

### 4.2. Фронтенд

-   **Аутентификация и Авторизация:**
    -   `LoginPage.jsx` и `RegisterPage.jsx`: Страницы с формами для входа и регистрации, использующие функции `login` и `register` из `AuthContext`.
    -   `AuthContext.jsx`: Управляет состоянием аутентификации (хранение токенов в localStorage, состояние пользователя), предоставляет функции `login`, `register`, `logout`, а главное - настроенный `apiClient` с перехватчиком для автоматического добавления Access токена в заголовки и логикой автоматического обновления Access токена при получении 401 ошибки, используя Refresh токен.
    -   `ProtectedRoute` и `PublicRoute` в `App.jsx`: Компоненты для защиты маршрутов, перенаправляющие неаутентифицированных пользователей на страницу входа и наоборот.
-   **Панель управления (`DashboardPage.jsx`, `components/display/TermStatisticsTable.jsx`, `components/display/AllConflictsReportList.jsx`):** Отображает приветствие пользователя, его основные данные, а также общую статистику использования терминов и полный отчет обо всех терминах с конфликтами, полученные с бэкенда через соответствующие API вызовы.
-   **Поиск (`SearchPage.jsx`, `components/TermItem.jsx`, `api/terms.js`):** Страница с полем ввода для поиска терминов. Использует `termsApi.getTerms` с параметром `query` для получения списка терминов, соответствующих поисковому запросу. Результаты отображаются списком с использованием компонента `TermItem`, который является ссылкой на детальную страницу термина.
-   **Страница Термина (`TermPage.jsx`, `components/TermItem.jsx`, `components/DocumentItem.jsx`, `components/display/TermConflictReport.jsx`, `components/TermEditForm.jsx`, `api/terms.js`, `api/documents.js`, `api/termDocumentRelations.js`):** Отображает детальную информацию о конкретном термине, полученную по его ID. Загружает сам термин (`termsApi.getTermById`), связанные с ним документы (`termsApi.getDocumentsForTerm`), отчет о конфликтах определений для этого термина (`termDocumentRelationsApi.getTermConflictsReport`). Отображает текущее определение, историю определений (включая подгрузку информации о документах-источниках при их наличии), список связанных документов (`DocumentItem`), и отчет о конфликтах (`TermConflictReport`). Предоставляет кнопку для перехода в режим редактирования (`TermEditForm.jsx`).
-   **Страница Документа (`DocumentPage.jsx`, `components/TermItem.jsx`, `api/documents.js`):** Отображает детальную информацию о конкретном нормативном документе, полученную по его ID (`documentsApi.getDocumentById`). Также загружает и отображает список терминов, связанных с этим документом (`documentsApi.getTermsForDocument`), используя компонент `TermItem`.
-   **Анализ Документа (`DocumentAnalysisPage.jsx`, `components/forms/DocumentUploadForm.jsx`, `components/display/TermAnalysisItem.jsx`, `api/documents.js`, `api/terms.js`):** Предоставляет форму для загрузки файла документа (`DocumentUploadForm`). После загрузки (на данный момент используется заглушка вместо реального парсинга), страница выполняет проверку конфликтов для каждого извлеченного (заглушечного) термина с помощью эндпоинта `checkTermConflict`. Результаты анализа отображаются в виде списка, где каждый элемент представлен компонентом `TermAnalysisItem`. `TermAnalysisItem` показывает данные термина, индикацию конфликта (если обнаружен) и, возможно, предоставляет поля для редактирования перед сохранением. Страница также имеет кнопку для массового сохранения всех извлеченных терминов с использованием эндпоинта `bulk-save`.

## 5. Тестирование (Подробно)

Директория `backend/tests/` содержит модули с тестами:
-   `conftest.py`: Содержит фикстуры `db_client_fixture` (подключение к тестовой MongoDB с очисткой перед каждым тестом), `db` (предоставляет тестовую БД), `app_client` (тестовый клиент FastAPI) и фикстуры для создания тестовых пользователей (`test_user`, `admin_user`) и заголовков аутентификации (`auth_headers`, `admin_auth_headers`). Это обеспечивает изолированное и удобное окружение для тестов.
-   `unit/`: Содержит юнит-тесты для отдельных частей логики:
    -   `test_auth.py`: Юнит-тесты для функций аутентификации (например, проверка хеширования паролей, создания токенов - *примечание: по факту содержат API тесты логина/регистрации/me*).
    -   `test_db_connection.py`: Тесты на установление соединения с тестовой БД и базовые CRUD операции на тестовой коллекции, а также проверка создания индексов (например, уникального индекса для email).
    -   `test_conflict_detection.py`: Юнит-тесты для логики выявления конфликтов определений в `CRUDTermDocument`.
-   `crud/`: Содержит интеграционные тесты для CRUD классов:
    -   `test_terms.py`: Тесты CRUD операций и поиска для терминов в `CRUDTerm`.
    -   `test_documents.py`: Тесты CRUD операций, поиска, а также добавления/удаления связанных терминов для документов в `CRUDDocument`.
    -   `test_term_document_relations.py`: Тесты CRUD операций, получения связей по ID термина/документа, удаления связей по различным критериям, а также тесты логики `check_for_conflicts` и `update_conflict_status` на уровне CRUD.
-   `api/`: Содержит интеграционные тесты для API эндпоинтов:
    -   `test_auth_api.py`: Тесты эндпоинтов регистрации, логина, обновления токена и доступа к защищенным маршрутам.
    -   `test_documents_api.py`: Тесты CRUD эндпоинтов для документов, получения терминов для документа, а также проверка автоматического удаления связей при удалении документа.
    -   `test_terms_api.py`: Тесты CRUD эндпоинтов для терминов, получения документов для термина, получения статистики терминов, а также проверка автоматического удаления связей при удалении термина.
    -   `test_term_document_relations_api.py`: Тесты CRUD эндпоинтов для связей, получения отчета о конфликтах для термина и полного отчета о конфликтах.

## 6. Текущий Статус и Предстоящие Задачи

Как подробно описано в предыдущем отчете, большая часть базового функционала реализована и покрыта тестами. Основной каркас приложения готов. 

Предстоящие задачи включают:
-   Разработку полного UI для управления терминами и документами (добавление, полноценное редактирование, включая историю определений).
-   Реализацию механизма разрешения конфликтов определений на фронтенде.
-   Создание полноценной административной панели.
-   Разработку функционала импорта/экспорта.
-   Интеграцию с реальным парсером документов и доработку логики сохранения документа после анализа.
-   Возможную интеграцию с внешними системами (СЭД университета).

Это описание дает более полное представление о структуре и реализованном функционале проекта "Единый глоссарий терминов ВНД".