# Общие Модули Бэкенда (`backend/shared/`)

Директория `backend/shared/` содержит Python модули, предназначенные для переиспользования в различных микросервисах бэкенда. Это помогает избежать дублирования кода, обеспечить консистентность и упростить разработку.

Docker-конфигурации каждого бэкенд-сервиса (`Dockerfile`) включают шаг копирования содержимого `backend/shared/` в рабочую директорию контейнера (например, `/app/shared`), делая эти модули доступными для импорта.

## 1. Конфигурация (`shared/config/`)

*   **`settings.py`**:
    *   Определяет класс `Settings` (наследник `pydantic_settings.BaseSettings`) для управления конфигурацией приложения.
    *   Загружает настройки из переменных окружения (по умолчанию из файла `.env` в корне проекта).
    *   Использует кэширование (`@lru_cache`) для функции `get_settings()`, чтобы настройки загружались один раз.
    *   Содержит такие параметры, как:
        *   `MONGO_URI`, `REDIS_URL`
        *   `JWT_SECRET_KEY`, `JWT_ALGORITHM`, `ACCESS_TOKEN_EXPIRE_MINUTES`, `REFRESH_TOKEN_EXPIRE_DAYS`
        *   `PROJECT_NAME`, `DEBUG` и другие общие настройки.
    *   **Пример использования в сервисе:**
        ```python
        from backend.shared.config import settings

        db_uri = settings.MONGO_URI
        if settings.DEBUG:
            print("Debug mode is ON")
        ```

## 2. Модели Данных (`shared/models/`)

*   Содержит Pydantic модели (схемы), используемые для валидации данных API запросов/ответов, а также для взаимодействия с базой данных (ORM-подобные модели).
*   Модели разделены на тематические файлы для лучшей организации:
    *   `base_schemas.py`: `BaseDBModel` (базовая модель для сущностей БД с `id`, `created_at`, `updated_at`).
    *   `user_schemas.py`: Модели, связанные с пользователями (`UserBase`, `UserCreate`, `UserRead`, `UserRole`, `UserInDB` и т.д.).
    *   `auth_schemas.py`: Модели для аутентификации (`LoginRequest`, `Token`, `TokenPayload`, `TokenType`, `PasswordResetRequest`, `RefreshTokenRequest` и т.д.).
    *   `response_schemas.py`: Общие модели для API ответов (`MessageResponse`, `StatusResponse`, `Paginated`, `ErrorDetail`, `ErrorResponse`).
    *   `item_schemas.py`: Пример моделей для CRUD операций над некой сущностью "Item".
    *   `health_schemas.py`: Модели для эндпоинтов проверки работоспособности (`HealthCheckResponse`, `DependencyHealth`).
*   Файл `__init__.py` в этой директории экспортирует все основные модели, позволяя импортировать их более коротким путем:
    ```python
    from backend.shared.models import UserRead, Token, Paginated
    ```

## 3. Утилиты (`shared/utils/`)

*   **`helpers.py`**:
    *   Содержит различные вспомогательные функции общего назначения.
    *   Пример: функция `setup_logger()` для быстрой настройки логгера.
*   **`security.py`**:
    *   Ключевой модуль для безопасности и аутентификации.
    *   `pwd_context`: Экземпляр `Passlib CryptContext` для хеширования и проверки паролей (использует bcrypt).
    *   `verify_password(plain_password, hashed_password)`: Проверка пароля.
    *   `get_password_hash(password)`: Хеширование пароля.
    *   `create_access_token(subject, custom_claims=None)`: Создание JWT access токена.
    *   `create_refresh_token(subject)`: Создание JWT refresh токена.
    *   `decode_jwt_token(token)`: Декодирование и валидация JWT токена. Возвращает `TokenPayload` или вызывает `JWTAuthenticationError`.
    *   `JWTAuthenticationError`: Пользовательское исключение для ошибок JWT.
*   Файл `__init__.py` в `shared/utils/` также экспортирует основные утилиты.

## 4. Исключения (`shared/exceptions/`)

*   **`custom.py`**:
    *   Определяет базовые пользовательские классы исключений, от которых можно наследоваться в сервисах.
    *   Примеры: `AppException` (базовое), `NotFoundException`, `BadRequestException`.
    *   Эти исключения можно использовать с обработчиками исключений FastAPI для возврата стандартизированных HTTP ответов об ошибках.
    ```python
    # Пример использования в FastAPI эндпоинте
    from backend.shared.exceptions import NotFoundException
    # ...
    # if not item:
    #     raise NotFoundException(resource_name="Item", resource_id=item_id)
    ```

Использование общих модулей `backend/shared/` значительно упрощает поддержку и развитие проекта, так как изменения в общей логике или моделях данных автоматически отражаются во всех использующих их микросервисах (после пересборки Docker образов). 